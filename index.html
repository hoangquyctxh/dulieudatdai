<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cổng Tải Lên Hồ Sơ - Làm Sạch Dữ Liệu Đất Đai</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for photo strip */
        #photo-strip::-webkit-scrollbar {
            height: 8px;
        }
        #photo-strip::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        #photo-strip::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        #photo-strip::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">

    <div class="w-full max-w-5xl bg-white rounded-2xl shadow-lg p-6 md:p-10 space-y-8">
        <!-- Header -->
        <header class="text-center">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/18/Emblem_of_Hanoi.svg/447px-Emblem_of_Hanoi.svg.png" alt="Logo Thủ đô Hà Nội" class="h-20 mx-auto mb-4">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-800">Cổng Tải Lên Hồ Sơ Đất Đai</h1>
            <p class="text-slate-600 mt-2">Nền tảng hỗ trợ công tác thu thập và làm sạch dữ liệu đất đai.</p>
        </header>
        
        <!-- Main Content -->
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
            <!-- Instructions Column -->
            <aside class="bg-slate-50 rounded-xl p-6 border border-slate-200">
                <h2 class="text-xl font-semibold text-slate-700 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-sky-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Hồ Sơ Cần Chuẩn Bị
                </h2>
                <ul class="space-y-4 text-slate-600 list-decimal list-inside">
                    <li>
                        <strong>Giấy chứng nhận quyền sử dụng đất, quyền sở hữu nhà ở</strong> (bản phô tô hoặc ảnh chụp rõ nét).
                    </li>
                    <li>
                        <strong>Căn cước công dân</strong> của tất cả chủ sở hữu (bản phô tô hoặc ảnh chụp rõ nét).
                        <p class="text-sm text-slate-500 ml-5 mt-1">Lưu ý: Nếu Giấy chứng nhận cấp cho nhiều người, vui lòng cung cấp Căn cước công dân của tất cả.</p>
                    </li>
                    <li>
                        <strong>Các giấy tờ liên quan khác</strong> (nếu có, ví dụ: phiếu hẹn, giấy tờ thừa kế...).
                    </li>
                </ul>
                <div class="mt-6 p-4 bg-sky-50 text-sky-800 rounded-lg border border-sky-200">
                    <h3 class="font-semibold">Hướng Dẫn Chụp Ảnh</h3>
                    <p class="text-sm mt-1">Khi sử dụng chức năng "Chụp ảnh", bạn có thể chụp nhiều ảnh. Hệ thống sẽ tự động gộp tất cả ảnh lại thành 1 tệp PDF duy nhất cho mục đó.</p>
                </div>
            </aside>

            <!-- Uploader Column -->
            <section>
                <!-- Submitter Info Form -->
                <div id="submitter-info" class="mb-8">
                     <h3 class="font-semibold text-slate-800 mb-5 flex items-center text-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4_0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                        Thông tin người nộp hồ sơ
                    </h3>
                    <div class="space-y-5">
                        <!-- Form Group -->
                        <div>
                            <label for="fullName" class="block text-sm font-medium text-slate-700 mb-1.5">Họ và tên chủ sở hữu <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3.5">
                                    <svg class="h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                                </div>
                                <input type="text" id="fullName" name="fullName" class="w-full rounded-lg border border-slate-300 bg-slate-50 py-3 pl-11 pr-4 text-slate-800 placeholder-slate-400 focus:border-sky-500 focus:ring-1 focus:ring-sky-500 transition" placeholder="Ví dụ: Nguyễn Văn A" required />
                            </div>
                        </div>
                        <!-- Form Group -->
                        <div>
                            <label for="idNumber" class="block text-sm font-medium text-slate-700 mb-1.5">Số Căn cước công dân <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3.5">
                                    <svg class="h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 9h3.75M15 12h3.75M15 15h3.75M4.5 19.5h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5zm-2.25-2.25v-1.125c0-.621.504-1.125 1.125-1.125H3.375v-1.5H2.25c-.621 0-1.125.504-1.125 1.125v1.125c0 .621.504 1.125 1.125 1.125H3.375v-1.5H2.25z" /></svg>
                                </div>
                                <input type="text" id="idNumber" name="idNumber" class="w-full rounded-lg border border-slate-300 bg-slate-50 py-3 pl-11 pr-4 text-slate-800 placeholder-slate-400 focus:border-sky-500 focus:ring-1 focus:ring-sky-500 transition" placeholder="Nhập 12 số trên thẻ" required />
                            </div>
                        </div>
                        <!-- Form Group -->
                        <div>
                            <label for="phoneNumber" class="block text-sm font-medium text-slate-700 mb-1.5">Số điện thoại liên hệ <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3.5">
                                    <svg class="h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3.5A1.5 1.5 0 013.5 2h1.148a1.5 1.5 0 011.465 1.175l.716 3.223a1.5 1.5 0 01-1.052 1.767l-.933.267c-.41.117-.643.555-.48.95a11.542 11.542 0 006.254 6.254c.395.163.833-.07.95-.48l.267-.933a1.5 1.5 0 011.767-1.052l3.223.716A1.5 1.5 0 0118 15.352V16.5a1.5 1.5 0 01-1.5 1.5h-1.528A13.941 13.941 0 012.228 3.728 1.5 1.5 0 013.5 2h0z" /></svg>
                                </div>
                                <input type="tel" id="phoneNumber" name="phoneNumber" class="w-full rounded-lg border border-slate-300 bg-slate-50 py-3 pl-11 pr-4 text-slate-800 placeholder-slate-400 focus:border-sky-500 focus:ring-1 focus:ring-sky-500 transition" placeholder="Ví dụ: 0912345678" required />
                            </div>
                        </div>
                        <!-- Form Group -->
                        <div>
                            <label for="landAddress" class="block text-sm font-medium text-slate-700 mb-1.5">Địa chỉ thửa đất <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3.5">
                                    <svg class="h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 00.281-.14c.186-.1.4-.27.61-.47c.21-.2.419-.413.618-.638c.199-.225.385-.46.56-.713c.174-.253.335-.518.48-.797c.145-.279.274-.57.388-.87c.114-.3.21-.613.288-.938c.078-.324.14-.658.182-1.002c.042-.344.062-.703.062-1.074c0-.371-.02-.73-.062-1.074a4.95 4.95 0 00-.182-1.002c-.078-.324-.174-.637-.288-.938c-.114-.3-.243-.591-.388-.87c-.145-.279-.306-.544-.48-.797c-.175-.253-.361-.488-.56-.713c-.199-.225-.408-.438-.618-.638c-.21-.2-.424-.37-.61-.47a5.741 5.741 0 00-.281-.14l-.018-.008-.006-.003zM10 11.25a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5z" clip-rule="evenodd" /></svg>
                                </div>
                                <input type="text" id="landAddress" name="landAddress" class="w-full rounded-lg border border-slate-300 bg-slate-50 py-3 pl-11 pr-4 text-slate-800 placeholder-slate-400 focus:border-sky-500 focus:ring-1 focus:ring-sky-500 transition" placeholder="Ghi rõ số nhà, đường, phường, quận" required />
                            </div>
                        </div>
                    </div>
                </div>

                <div id="upload-container" class="space-y-5">
                    <!-- Section 1: Certificate -->
                    <div class="upload-section-item bg-white border border-slate-200 p-5 rounded-xl shadow-sm transition-all hover:shadow-md">
                        <h3 class="font-semibold text-slate-800 mb-3 flex items-center text-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                            1. Giấy chứng nhận quyền sử dụng đất
                        </h3>
                        <div id="file-display-certificate"></div>
                        <div class="flex space-x-3 mt-3">
                            <button onclick="triggerFileInput('certificate')" class="upload-btn">Tải tệp lên</button>
                            <button onclick="openCameraModal('certificate')" class="camera-btn">Chụp ảnh</button>
                        </div>
                        <input type="file" id="file-input-certificate" onchange="handleFileSelect(event, 'certificate')" class="hidden" accept=".pdf,.jpg,.jpeg,.png,.heic">
                    </div>

                    <!-- Section 2: ID Card -->
                    <div class="upload-section-item bg-white border border-slate-200 p-5 rounded-xl shadow-sm transition-all hover:shadow-md">
                        <h3 class="font-semibold text-slate-800 mb-3 flex items-center text-lg">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 012-2h2a2 2 0 012 2v1m-6 0h6" /></svg>
                            2. Căn cước công dân
                        </h3>
                        <div id="file-display-idCard"></div>
                        <div class="flex space-x-3 mt-3">
                            <button onclick="triggerFileInput('idCard')" class="upload-btn">Tải tệp lên</button>
                            <button onclick="openCameraModal('idCard')" class="camera-btn">Chụp ảnh</button>
                        </div>
                        <input type="file" id="file-input-idCard" onchange="handleFileSelect(event, 'idCard')" class="hidden" accept=".pdf,.jpg,.jpeg,.png,.heic">
                    </div>
                    
                    <!-- Section 3: Other Docs -->
                    <div class="upload-section-item bg-white border border-slate-200 p-5 rounded-xl shadow-sm transition-all hover:shadow-md">
                         <h3 class="font-semibold text-slate-800 mb-3 flex items-center text-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 14v6m-3-3h6M6 10h2a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2zm10 0h2a2 2 0 002-2V6a2 2 0 00-2-2h-2a2 2 0 00-2 2v2a2 2 0 002 2zM6 18h2a2 2 0 002-2v-2a2 2 0 00-2-2H6a2 2 0 00-2 2v2a2 2 0 002 2z" /></svg>
                            3. Các giấy tờ liên quan khác (nếu có)
                        </h3>
                        <div id="file-display-otherDocs"></div>
                        <div class="flex space-x-3 mt-3">
                            <button onclick="triggerFileInput('otherDocs')" class="upload-btn">Tải tệp lên</button>
                            <button onclick="openCameraModal('otherDocs')" class="camera-btn">Chụp ảnh</button>
                        </div>
                        <input type="file" id="file-input-otherDocs" onchange="handleFileSelect(event, 'otherDocs')" class="hidden" accept=".pdf,.jpg,.jpeg,.png,.heic">
                    </div>
                </div>

                <div class="mt-8">
                    <button id="submit-btn" class="w-full bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-emerald-700 focus:outline-none focus:ring-4 focus:ring-emerald-300 transition-all duration-300 disabled:bg-slate-400 transform hover:scale-105">
                        Gửi Toàn Bộ Hồ Sơ
                    </button>
                </div>
            </section>
        </main>
        
        <div id="success-message" class="hidden mt-4 p-6 text-center bg-emerald-50 text-emerald-800 rounded-xl border border-emerald-200">
            <svg class="w-16 h-16 mx-auto mb-4 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <p class="text-xl font-semibold">Gửi hồ sơ thành công!</p>
            <p class="text-slate-600 mt-1">Cảm ơn sự hợp tác của bạn. Chúng tôi đã tiếp nhận hồ sơ.</p>
        </div>

        <footer class="mt-6 text-center border-t border-slate-200 pt-6">
            <h2 class="text-lg font-semibold text-slate-700">Nơi Liên Hệ & Tiếp Nhận</h2>
            <p class="text-slate-600 mt-2">Mọi thắc mắc, vui lòng liên hệ: 
                <span class="font-medium text-sky-700 mt-1">Tổ trưởng Tổ dân phố nơi có nhà đất.</span>
            </p>
        </footer>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl flex flex-col" style="max-height: 95vh;">
            <header class="p-4 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">Chụp Ảnh Tài Liệu</h3>
                <button onclick="closeCameraModal()" class="text-slate-500 hover:text-slate-800">&times;</button>
            </header>
            <main class="p-4 flex-grow overflow-y-auto bg-slate-50">
                <div class="relative bg-black rounded-lg overflow-hidden shadow-inner">
                    <video id="camera-video" playsinline autoplay class="w-full h-auto"></video>
                    <canvas id="camera-canvas" class="hidden"></canvas>
                </div>
                 <div class="flex justify-center mt-4">
                     <button id="capture-btn" class="p-4 bg-sky-600 rounded-full text-white hover:bg-sky-700 focus:outline-none focus:ring-4 focus:ring-sky-300 transform hover:scale-110 transition-transform" title="Chụp ảnh">
                        <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.776 48.776 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z" /><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z" /></svg>
                     </button>
                 </div>
                 <div id="photo-preview-area" class="mt-4 hidden">
                    <h4 class="font-semibold mb-2 text-sm text-slate-600">Ảnh đã chụp (<span id="photo-count">0</span>):</h4>
                    <div id="photo-strip" class="flex items-center space-x-3 h-28 p-2 bg-slate-100 rounded-lg border"></div>
                 </div>
            </main>
            <footer class="flex justify-end p-4 bg-slate-100 border-t rounded-b-lg space-x-3">
                 <button id="cancel-camera-btn" class="px-5 py-2 bg-slate-300 text-slate-800 rounded-lg hover:bg-slate-400 font-semibold transition-colors">Hủy</button>
                 <button id="generate-pdf-btn" class="px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 disabled:bg-slate-400 font-semibold transition-colors" disabled>Tạo PDF & Sử dụng</button>
            </footer>
        </div>
    </div>
    
    <!-- Custom Alert Modal -->
    <div id="alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <p id="alert-message" class="text-slate-700 mb-6"></p>
            <button onclick="closeAlert()" class="px-8 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700 font-semibold transition-colors">Đã hiểu</button>
        </div>
    </div>


    <script>
        // --- Tailwind CSS Custom Classes ---
        // Applying classes via JS to keep HTML clean
        document.querySelectorAll('.upload-btn').forEach(btn => {
            btn.className = 'flex-1 text-sm bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold py-2 px-4 rounded-lg transition-colors';
        });
        document.querySelectorAll('.camera-btn').forEach(btn => {
            btn.className = 'flex-1 text-sm bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors';
        });

        // --- PDF Library ---
        const { jsPDF } = window.jspdf;

        // --- State Management ---
        const uploadedFiles = { certificate: null, idCard: null, otherDocs: null };
        const categoryFullNames = {
            certificate: 'Giay_chung_nhan_quyen_su_dung_dat',
            idCard: 'Can_cuoc_cong_dan',
            otherDocs: 'Giay_to_lien_quan_khac'
        };
        let currentCameraCategory = null;
        let capturedPhotos = [];

        // --- DOM Elements ---
        const mainContent = document.querySelector('main');
        const submitBtn = document.getElementById('submit-btn');
        const successMessage = document.getElementById('success-message');
        const cameraModal = document.getElementById('camera-modal');
        const video = document.getElementById('camera-video');
        const canvas = document.getElementById('camera-canvas');
        const alertModal = document.getElementById('alert-modal');
        const alertMessage = document.getElementById('alert-message');
        
        // --- Core Functions ---
        function triggerFileInput(category) {
            document.getElementById(`file-input-${category}`).click();
        }

        function handleFileSelect(event, category) {
            const file = event.target.files[0];
            if (file) {
                uploadedFiles[category] = file;
                updateFileDisplay(category);
            }
        }

        function updateFileDisplay(category) {
            const displayDiv = document.getElementById(`file-display-${category}`);
            const file = uploadedFiles[category];
            if (file) {
                displayDiv.innerHTML = `
                    <div class="flex items-center justify-between pl-3 pr-2 py-2 mt-2 bg-sky-50 border border-sky-200 rounded-lg text-sm animate-fade-in">
                        <div class="flex items-center space-x-3 overflow-hidden">
                            <svg class="w-6 h-6 text-sky-600 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                            <div class="truncate">
                                <p class="truncate font-semibold text-sky-800">${file.name}</p>
                                <p class="text-xs text-slate-500">${formatBytes(file.size)}</p>
                            </div>
                        </div>
                        <button onclick="removeFile('${category}')" class="text-slate-500 hover:text-red-600 p-1.5 rounded-full transition-colors flex-shrink-0">
                           <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                `;
            } else {
                displayDiv.innerHTML = '';
            }
        }
        
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function removeFile(category) {
            uploadedFiles[category] = null;
            document.getElementById(`file-input-${category}`).value = '';
            updateFileDisplay(category);
        }

        // --- Camera & PDF Functions ---
        async function openCameraModal(category) {
            currentCameraCategory = category;
            cameraModal.classList.remove('hidden');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
            } catch (err) {
                showAlert("Không thể truy cập camera. Vui lòng kiểm tra và cấp quyền truy cập camera trong cài đặt của trình duyệt.");
                closeCameraModal();
            }
        }

        function closeCameraModal() {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            cameraModal.classList.add('hidden');
            capturedPhotos = [];
            document.getElementById('photo-strip').innerHTML = '';
            document.getElementById('photo-count').textContent = '0';
            document.getElementById('photo-preview-area').classList.add('hidden');
            document.getElementById('generate-pdf-btn').disabled = true;
        }
        
        document.getElementById('capture-btn').addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            capturedPhotos.push(canvas.toDataURL('image/jpeg'));
            updatePhotoStrip();
        });

        function updatePhotoStrip() {
            document.getElementById('photo-preview-area').classList.remove('hidden');
            const strip = document.getElementById('photo-strip');
            strip.innerHTML = '';
            capturedPhotos.forEach((dataUrl, index) => {
                const imgContainer = document.createElement('div');
                imgContainer.className = 'relative flex-shrink-0';
                imgContainer.innerHTML = `
                    <img src="${dataUrl}" class="h-24 w-auto rounded border-2 border-slate-300">
                    <button onclick="removePhoto(${index})" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full h-6 w-6 flex items-center justify-center text-sm shadow-md">&times;</button>
                `;
                strip.appendChild(imgContainer);
            });
            strip.scrollLeft = strip.scrollWidth;
            document.getElementById('photo-count').textContent = capturedPhotos.length;
            document.getElementById('generate-pdf-btn').disabled = capturedPhotos.length === 0;
        }

        function removePhoto(index) {
            capturedPhotos.splice(index, 1);
            updatePhotoStrip();
        }

        document.getElementById('generate-pdf-btn').addEventListener('click', () => {
            const doc = new jsPDF();
            capturedPhotos.forEach((dataUrl, index) => {
                if (index > 0) doc.addPage();
                const imgProps = doc.getImageProperties(dataUrl);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = doc.internal.pageSize.getHeight();
                const widthRatio = pdfWidth / imgProps.width;
                const heightRatio = pdfHeight / imgProps.height;
                const ratio = Math.min(widthRatio, heightRatio);
                const imgWidth = imgProps.width * ratio;
                const imgHeight = imgProps.height * ratio;
                const x = (pdfWidth - imgWidth) / 2;
                const y = (pdfHeight - imgHeight) / 2;
                doc.addImage(dataUrl, 'JPEG', x, y, imgWidth, imgHeight);
            });
            const pdfBlob = doc.output('blob');
            const fullName = categoryFullNames[currentCameraCategory] || 'Tai_lieu';
            const fileName = `Anh_chup_${fullName}_${Date.now()}.pdf`;
            const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });
            
            uploadedFiles[currentCameraCategory] = pdfFile;
            updateFileDisplay(currentCameraCategory);
            closeCameraModal();
        });
        
        document.getElementById('cancel-camera-btn').addEventListener('click', closeCameraModal);

        // --- Alert Modal ---
        function showAlert(message) {
            alertMessage.textContent = message;
            alertModal.classList.remove('hidden');
        }
        function closeAlert() {
            alertModal.classList.add('hidden');
        }

        // --- Submission ---
        submitBtn.addEventListener('click', () => {
            // Validate form fields
            const fullName = document.getElementById('fullName').value.trim();
            const idNumber = document.getElementById('idNumber').value.trim();
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const landAddress = document.getElementById('landAddress').value.trim();

            if (!fullName || !idNumber || !phoneNumber || !landAddress) {
                showAlert("Vui lòng điền đầy đủ thông tin người nộp hồ sơ.");
                return;
            }

             if (Object.values(uploadedFiles).every(file => file === null)) {
                showAlert("Vui lòng tải lên ít nhất một loại giấy tờ để gửi hồ sơ.");
                return;
            }
            
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzf6FnKeXFiG4F_2mKeU1Xzl8RWfeSxNNG4CwW9HXx1MGUZrR1wxGCIC5tFowfAqMVb7w/exec";

            submitBtn.disabled = true;
            submitBtn.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Đang xử lý...`;
            submitBtn.classList.add('inline-flex', 'items-center', 'justify-center');

            const submissionData = {
                fullName: fullName,
                idNumber: idNumber,
                phoneNumber: phoneNumber,
                landAddress: landAddress,
            };

            const filePromises = Object.keys(uploadedFiles).map(key => {
                const file = uploadedFiles[key];
                if (file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            submissionData[key] = {
                                fileName: file.name,
                                mimeType: file.type,
                                base64: event.target.result
                            };
                            resolve();
                        };
                        reader.onerror = (error) => reject(error);
                        reader.readAsDataURL(file);
                    });
                }
                return Promise.resolve();
            });

            Promise.all(filePromises)
                .then(() => {
                    fetch(SCRIPT_URL, {
                        method: 'POST',
                        // body is a string, so we need to use 'text/plain'
                        mode: 'no-cors', // IMPORTANT: Use no-cors mode for Apps Script
                        body: JSON.stringify(submissionData),
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8', // Send as plain text
                        },
                    })
                    // Because of 'no-cors', we can't read the response. 
                    // We will assume success if the request doesn't throw an error.
                    .then(() => {
                        console.log("Request sent to Apps Script.");
                        // Simulate a short delay to allow the script to process
                        setTimeout(() => {
                           document.getElementById('submitter-info').classList.add('hidden');
                           document.querySelector('main').classList.add('hidden');
                           document.getElementById('submit-btn').classList.add('hidden');
                           document.getElementById('success-message').classList.remove('hidden');
                        }, 1500); // Wait 1.5 seconds before showing success
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showAlert('Đã có lỗi xảy ra khi gửi hồ sơ. Vui lòng thử lại.');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Gửi Toàn Bộ Hồ Sơ';
                        submitBtn.classList.remove('inline-flex', 'items-center', 'justify-center');
                    });
                })
                .catch(error => {
                    console.error('Lỗi khi đọc tệp:', error);
                    showAlert('Đã có lỗi xảy ra khi xử lý tệp. Vui lòng thử lại.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Gửi Toàn Bộ Hồ Sơ';
                    submitBtn.classList.remove('inline-flex', 'items-center', 'justify-center');
                });
        });
    </script>
</body>
</html>

